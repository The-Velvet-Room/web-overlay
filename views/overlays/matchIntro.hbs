<!DOCTYPE html>
<html>
  <head>
    <title>{{title}}</title>
    <link href='http://fonts.googleapis.com/css?family=Oswald' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Covered+By+Your+Grace' rel='stylesheet' type='text/css'>
    <link rel='stylesheet' href='/stylesheets/overlays/matchIntro.css' />
    <script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenMax.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
    <div id="container">
      <audio  id="audio-chime" 
            src="https://dl.dropboxusercontent.com/u/35469595/ssb64_challenge.mp3"
            autoplay="false">
      </audio>
      <h1 id="tourneyInfo" class="text"></h1>
      <div id="lContainer">
        <img id="lCharacter" class="fadeIn" height="640" width="640" src="" />
        <h3 id="lplayer" class="text"></h1>
      </div>
      <h3 id="vs" class="text">VS</h3>
      <div id="rContainer">
        <img id="rCharacter" class="fadeIn" height="640" width="640" src="" />
        <h3 id="rplayer" class="text"></h1>
      </div>    
    </div>

    <script type="text/javascript">
     
    var charImageDict = {
      'bowser':'http://i.imgur.com/33mnA2Z.png',
      'bowser-jr':'http://i.imgur.com/utEfXhv.png',
      'captain-falcon':'http://i.imgur.com/VnFfZpr.png',
      'charizard':'http://i.imgur.com/8kwiHWb.png',
      'dark-pit':'http://i.imgur.com/3ysRfec.png',
      'king-dedede':'http://i.imgur.com/uBTmrmm.png',
      'diddy-kong':'http://i.imgur.com/LFFmRbh.png',
      'donkey-kong':'http://i.imgur.com/v9lQZp3.png',
      'dr-mario':'http://i.imgur.com/cA0i15d.png',
      'duck-hunt-dog':'http://i.imgur.com/KyA0bd9.png',
      'falco':'http://i.imgur.com/mrm67Km.png',
      'fox':'http://i.imgur.com/QLAlYLe.png',
      'ganondorf':'http://i.imgur.com/ikXkjzG.png',
      'mr-game-and-watch':'http://i.imgur.com/9HkP2As.png',
      'greninja':'http://i.imgur.com/67HjDjf.png',
      'ice-climbers':'http://i.imgur.com/twwSNBt.png',
      'ike':'http://i.imgur.com/C5Iy1FA.png',
      'ivysaur':'http://i.imgur.com/5rOZ4bQ.png',
      'jigglypuff':'http://i.imgur.com/07bIHUQ.png',
      'kirby':'http://i.imgur.com/uTbJKiX.png',
      'link':'http://i.imgur.com/aBLV6AT.png',
      'little-mac':'http://i.imgur.com/4CCrBIW.png',
      'lucario':'http://i.imgur.com/vjf39o3.png', 
      'lucas':'http://i.imgur.com/OjCaKKo.png',
      'lucina':'http://i.imgur.com/77uMLO3.png',
      'luigi':'http://i.imgur.com/zWPNj42.png',
      'mario':'http://i.imgur.com/G3D9Vor.png',
      'marth':'http://i.imgur.com/IKq3QVI.png',
      'megaman':'http://i.imgur.com/YT9FqNW.png',
      'metaknight':'http://i.imgur.com/sVKxeAN.png',
      'mewtwo':'http://i.imgur.com/6hDgNxL.png',
      'ness':'http://i.imgur.com/Au1yPpr.png',
      'olimar':'http://i.imgur.com/BHVKXSI.png',
      'pacman':'http://i.imgur.com/0Uee64Y.png',
      'palutena':'http://i.imgur.com/p0MmRME.png',
      'peach':'http://i.imgur.com/QR9zMJH.png',
      'pichu':'http://i.imgur.com/UwABGrm.png',
      'pikachu':'http://i.imgur.com/s9jVBIj.png',
      'pit':'http://i.imgur.com/nIFWN3e.png',
      'rob':'http://i.imgur.com/RUke4jQ.png',
      'robin':'http://i.imgur.com/1wJQWnn.png',
      'rosalina':'http://i.imgur.com/2M8vNOj.png',
      'roy':'http://i.imgur.com/Ly1AefK.png',
      'samus':'http://i.imgur.com/MvdeKZO.png',
      'sheik':'http://i.imgur.com/TQa1vyE.png',
      'shulk':'http://i.imgur.com/yvC9dUw.png',
      'snake':'http://i.imgur.com/v9bLHnh.png',
      'squirtle':'http://i.imgur.com/53GnJO9.png',
      'sonic':'http://i.imgur.com/dd7uiqO.png',
      'toon-link':'http://i.imgur.com/OatfTG3.png',
      'villager':'http://i.imgur.com/ttw0VUb.png',
      'wario':'http://i.imgur.com/qqT1qXA.png',
      'wii-fit-trainer':'http://i.imgur.com/gzNFSPv.png',
      'wolf':'http://i.imgur.com/VuSCu3h.png',
      'yoshi':'http://i.imgur.com/OMmtBeC.png',
      'young-link':'http://i.imgur.com/6qOfR58.png',
      'zelda':'http://i.imgur.com/sdCoRJx.png',
      'zero-suit-samus':'http://i.imgur.com/X7UHAGe.png'
    }
    
    var mainTl = new TimelineMax({repeat:-1, paused:true});

    $(document).ready(function () {
      var step = 0;
      var socket = io('/overlay');
      
      // For some reason the autoplay property doesn't work in Chrome
      document.getElementById("audio-chime").pause();   
      CreateMainTimeline();

      socket.on('play intro', function(data) {
        if(data.flag !== step) { 
          return true;
        }

        if (data.flag === 0) {
          // Reset the page and fade out background
          PlayLabel('reset');
          step = 1;
        } else if (data.flag === 1) {
          // Update the page with all relevant data/images
          $('#tourneyInfo').text(data.tourneyInfo || '');
          $('#lplayer').text(data.lplayer || '');
          $('#rplayer').text(data.rplayer || '');
          $('#lCharacter').attr('src', charImageDict[data.lCharacter] || '');
          $('#rCharacter').attr('src', charImageDict[data.rCharacter] || '');

          step = 2;
        } else {
          // Show the background again and begin animation
          PlayLabel('transition');
          step = 0;            
        }     
      });        
    });
    
    function CreateMainTimeline() {
      mainTl.add(CreateResetTimeline(), 'reset');
      mainTl.add(CreateTransitionTimeline(), 'transition');
    }

    function CreateResetTimeline() {
      var tl = new TimelineMax();
      tl.set('body', {backgroundColor:'rgba(0,0,0,0)'})
        .to('#container', .5, {opacity:0})
        .set('#container', {background: 'url(http://i.imgur.com/tlhS4vA.png)'})
        .set('#lCharacter', {opacity:0, marginLeft: '-3%'})
        .set('#rCharacter', {opacity:0, marginLeft: '-3%'})
        .set('#vs', {fontSize: '100em', display: 'none'})
        .set(['#tourneyInfo', '#lplayer', '#rplayer'], {display: 'none'});
      
      return tl;
    }
        
    function CreateTransitionTimeline() {
      var tl = new TimelineMax();
      tl.to('#container', .5, {opacity:1})
        .set('body', {backgroundColor: 'rgba(255,255,254,1)'})
        .staggerTo('.fadeIn', .35, {opacity: 1, marginLeft: 0}, .5, '+=.1')
        .addCallback(PlayChime, '+=0')
        .add(ScreenFlash(.05, .05, 0))    
        .add(ScreenFlash(.15, .15, 0), '+=.1')
        .set('#vs', {display:'block'})
        .to('#vs', .2, {fontSize: '9em'}, '+=.65')
        .add(ScreenFlash(.025, .5, .5))
        .set('#container', {background: 'url(http://i.imgur.com/WcNnLNO.gif)'}, '-=1')
        .set(['#tourneyInfo', '#lplayer', '#rplayer'], {display: 'block'});
        
      return tl;
    }
    
    function ScreenFlash(o, i, delay) {
        var tl = new TimelineMax();
        tl.to('#container', o, {opacity:0})
          .to('#container', i, {opacity:1}, '+=' + delay);
        
        return tl;
    }
    
    function PlayChime() {
      document.getElementById('audio-chime').play();
    }
    
    function PlayLabel(label, tl) {
      if (!tl)
        tl = mainTl;
      
      var next = tl.getLabelAfter(tl.getLabelTime(label));
      if (next)
        tl.tweenFromTo(label, next);     
      else
        tl.tweenFromTo(label, tl.endTime());    
    }
    </script>
  </body>
</html>
