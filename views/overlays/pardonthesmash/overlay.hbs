<!DOCTYPE html>
<html>
  <head>
    <title>{{title}}</title>
    <link rel='stylesheet' href='/stylesheets/overlays/pardonthesmash/overlay.css' />
    <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700' rel='stylesheet' type='text/css'>
    <script src="/javascripts/overlays/pardonthesmash/timer.js"></script>
    <script src="/socket.io/socket.io.js"></script>
  </head>
  <body>
  	<div id="container">
      <div id="video"></div>
      <div id="sidebar">
        <div id="timer-container">
          <div id="timer"></div>
        </div>
        <div id="topic-container">
          <div id="topic-header">
            TOPICS
          </div>
          <div id="topic-list">
            <div class="topic">
            </div>
          </div>
        </div>
      </div>
      <div id="mainbar-container">
      <img src="http://i.imgur.com/reVFLOP.png" id="smashball">

      <div id="mainbar"></div></div>
  	</div>
    <script>
		var socket = io();
    var endTime;
    var timerTimeout;
    var topics;
		
		socket.on('connect', function() {
			socket.emit('request timer pts');
      socket.emit('request topics pts');
		});
		
		socket.on('start timer pts', function(data) {
      if (data.endTime) {
        endTime = data.endTime;
        clearTimer();
        updateTimer();
      }
		});

    socket.on('update topics pts', function(data) {
      if (data.length !== 0) {
        renderTopics(data);
      }
    });

    function clearTimer() {
      clearTimeout(timerTimeout);
    }

    function updateTimer() {
      var time = timeLeft(endTime);
      document.getElementById('timer').innerText = formatTime(time);
      if (time.minutes !== 0 || time.seconds !== 0) {
        timerTimeout = setTimeout(updateTimer, 1000);
      }
    }

    function renderTopics(data) {
      var foundActive = false;
      topics = data;
      var container = document.getElementById('topic-list');
      var mainbar = document.getElementById('mainbar');

      var template = container.children[0];
      template.classList.remove('active');
      template.classList.remove('old');

      container.innerHTML = "";
      for (var i = 0; i < topics.length; i++) {
        var newTopic = template.cloneNode(true);
        var topicData = topics[i];
        newTopic.innerText = topicData.sidebar;

        container.appendChild(newTopic);

        if (topicData.active) {
          newTopic.classList.add('active');
          mainbar.innerText = topicData.mainbar;
          foundActive = true;
        } else if (!foundActive) {
          newTopic.classList.add('old');
        }
      }
    }
    </script>
  </body>
</html>
